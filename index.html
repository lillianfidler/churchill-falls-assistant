<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Churchill Falls Information Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #1e3c72;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            color: #64748b;
            font-size: 16px;
            line-height: 1.6;
        }

        .nav-links {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
        }

        .nav-links a {
            color: #3b82f6;
            text-decoration: none;
            font-weight: 500;
            margin-right: 20px;
            transition: color 0.2s;
        }

        .nav-links a:hover {
            color: #2563eb;
            text-decoration: underline;
        }

        .chat-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .chat-section h2 {
            color: #1e3c72;
            font-size: 24px;
            margin-bottom: 20px;
        }

        #chatContainer {
            height: 550px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: #f8fafc;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            flex-shrink: 0;
        }

        .user .message-avatar {
            background: #3b82f6;
            color: white;
        }

        .assistant .message-avatar {
            background: #1e3c72;
            color: white;
        }

        .message-content {
            flex: 1;
            line-height: 1.6;
            color: #1e293b;
        }

        .message-content p {
            margin-bottom: 10px;
        }

        .message-content a {
            color: #3b82f6;
            text-decoration: none;
        }

        .message-content a:hover {
            text-decoration: underline;
        }

        .loading {
            display: flex;
            gap: 4px;
            padding: 8px 0;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #3b82f6;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            max-width: 800px;
        }

        #userInput {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.2s;
        }

        #userInput:focus {
            outline: none;
            border-color: #3b82f6;
        }

        #sendButton, #resetButton {
            padding: 12px 24px;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            white-space: nowrap;
        }

        #sendButton {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        #sendButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        #sendButton:active {
            transform: translateY(0);
        }

        #resetButton {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
        }

        #resetButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(100, 116, 139, 0.4);
        }

        #resetButton:active {
            transform: translateY(0);
        }

        .mode-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: #f1f5f9;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .mode-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .mode-checkbox label {
            color: #475569;
            font-size: 14px;
            cursor: pointer;
        }

        .example-questions {
            color: #64748b;
            font-size: 13px;
            margin-bottom: 15px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Churchill Falls Information Assistant</h1>
            <p>Your comprehensive resource for understanding the Churchill Falls hydroelectric agreements</p>
            <div class="nav-links">
                <a href="index.html">Home</a>
                <a href="about.html">About</a>
            </div>
        </div>

        <div class="chat-section">
            <h2>Ask Your Questions</h2>

            <div id="chatContainer">
                <!-- Messages will appear here -->
            </div>

            <div class="mode-checkbox">
                <input type="checkbox" id="mouOnlyMode">
                <label for="mouOnlyMode"><strong>MOU Text Only</strong> - Reference only the official December 2024 MOU (excludes analysis and commentary)</label>
            </div>

            <div class="input-container">
                <input 
                    type="text" 
                    id="userInput" 
                    placeholder="Type your question here... (e.g., 'What does the MOU say about electricity pricing?')"
                    autocomplete="off"
                >
                <button id="sendButton">Ask →</button>
                <button id="resetButton">Reset</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://churchill-falls.onrender.com/api/chat';
        let conversationHistory = [];

        // Send message on Enter key
        document.getElementById('userInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Send message on button click
        document.getElementById('sendButton').addEventListener('click', sendMessage);

        // Reset conversation on reset button click
        document.getElementById('resetButton').addEventListener('click', function() {
            if (confirm('Are you sure you want to clear the conversation?')) {
                conversationHistory = [];
                document.getElementById('chatContainer').innerHTML = '';
                showWelcomeMessage();
                document.getElementById('userInput').value = '';
                document.getElementById('userInput').focus();
            }
        });

        // Show welcome message when page loads
        window.addEventListener('load', function() {
            showWelcomeMessage();
            document.getElementById('userInput').focus();
        });

        function showWelcomeMessage() {
            const welcomeText = `Hello! I'm here to help you understand the Churchill Falls hydroelectric project and the proposed December 2024 MOU between Newfoundland and Labrador and Quebec.

**What I can help with:**
I have access to the official MOU documents, economic analyses by Dr. Doug May and other researchers, historical agreements, and corporate reports. You can ask me about pricing structures, proposed projects, economic impacts, and more.

**Choose your focus:**
• Check **"MOU Text Only"** below to explore just the official agreement
• Leave it unchecked for comprehensive answers including expert analyses and commentary

**Ready to start?** Type your question below. For more information about this assistant and the sources used, visit the **About** page.`;
            
            addMessage('assistant', welcomeText);
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            
            if (!message) return;

            const mouOnlyMode = document.getElementById('mouOnlyMode').checked;
            const mode = mouOnlyMode ? 'mou-only' : 'comprehensive';

            // Clear welcome message on first question
            if (conversationHistory.length === 0) {
                document.getElementById('chatContainer').innerHTML = '';
            }

            // Add user message to chat
            addMessage('user', message);
            input.value = '';

            // Show loading indicator
            const loadingId = showLoading();

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        mode: mode,
                        conversationHistory: conversationHistory
                    })
                });

                const data = await response.json();

                // Remove loading indicator
                removeLoading(loadingId);

                if (data.error) {
                    addMessage('assistant', 'I apologize, but I encountered an error. Please try again.');
                } else {
                    addMessage('assistant', data.response);
                    
                    // Update conversation history
                    conversationHistory.push({
                        role: 'user',
                        content: message
                    });
                    conversationHistory.push({
                        role: 'assistant',
                        content: data.response
                    });
                }

            } catch (error) {
                removeLoading(loadingId);
                addMessage('assistant', 'I apologize, but I encountered an error. Please try again.');
                console.error('Error:', error);
            }
        }

        function addMessage(role, content) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'user' ? 'You' : 'CF';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            // Convert markdown-style formatting to HTML
            let formattedContent = content
                // Headers (must come before bold to avoid conflicts)
                .replace(/^### (.*$)/gim, '<h3 style="font-size: 16px; font-weight: 600; margin: 12px 0 8px 0; color: #1e3c72;">$1</h3>')
                .replace(/^## (.*$)/gim, '<h2 style="font-size: 18px; font-weight: 600; margin: 14px 0 10px 0; color: #1e3c72;">$1</h2>')
                .replace(/^# (.*$)/gim, '<h1 style="font-size: 20px; font-weight: 600; margin: 16px 0 12px 0; color: #1e3c72;">$1</h1>')
                // Bold
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Links
                .replace(/\[([^\]]+)\]\(([^\)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
                // Paragraphs and line breaks
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
            
            contentDiv.innerHTML = '<p>' + formattedContent + '</p>';
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            chatContainer.appendChild(messageDiv);
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showLoading() {
            const chatContainer = document.getElementById('chatContainer');
            const loadingDiv = document.createElement('div');
            const loadingId = 'loading-' + Date.now();
            loadingDiv.id = loadingId;
            loadingDiv.className = 'message assistant';
            loadingDiv.innerHTML = `
                <div class="message-avatar">CF</div>
                <div class="message-content loading">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
            `;
            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return loadingId;
        }

        function removeLoading(loadingId) {
            const loadingDiv = document.getElementById(loadingId);
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        function showLoading() {
            const chatContainer = document.getElementById('chatContainer');
            const loadingDiv = document.createElement('div');
            const loadingId = 'loading-' + Date.now();
            loadingDiv.id = loadingId;
            loadingDiv.className = 'message assistant';
            loadingDiv.innerHTML = `
                <div class="message-avatar">CF</div>
                <div class="message-content loading">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
            `;
            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return loadingId;
        }
    </script>
</body>
</html>